@model WKT.Model.SiteContentEntity

@{
    ViewBag.Title = "Create";
}
<link href="@Html.RootPath()/Content/MiniColors/jquery.miniColors.css" rel="stylesheet" type="text/css" />
<style type="text/css">
    body{ font-size:12px;}
    .l-table-edit {border:1px solid #bed5f3;border-collapse: collapse;width:100%}
    .l-table-edit-td-left{ padding:4px;text-align:right;width:100px;}
    .l-table-edit-td{ padding:4px;}
    .l-button-submit,.l-button-test{width:80px; float:left; margin-left:10px; padding-bottom:2px;}    
</style>
<div style="width: 98%; padding: 5px;">
    <form name="form1" method="post" id="form1">
    <table cellpadding="0" cellspacing="0" class="l-table-edit">
        <tr>
            <td align="right" class="l-table-edit-td-left">
                <span style="color: Red">*</span>标题：
            </td>
            <td align="left" class="l-table-edit-td">
                <input type="text" id="txtTitle" ltype="text" maxlength="50" value="@Model.Title" />
            </td>
            <td align="right" class="l-table-edit-td-left">
                关键字：
            </td>
            <td align="left" class="l-table-edit-td">
                <input type="text" id="txtTags" ltype="text" maxlength="50" value="@Model.Tags" />
            </td>
        </tr>
        <tr>
            <td align="right" class="l-table-edit-td-left">
                标题属性：
            </td>
            <td align="left" class="l-table-edit-td">
                <input type="checkbox" id="chkIsBold" /><label for="chkIsBold">是否粗体</label>
                <input type="checkbox" id="chkIsItalic" /><label for="chkIsItalic">是否斜体</label>
            </td>
            <td align="right" class="l-table-edit-td-left">
                标题颜色：
            </td>
            <td align="left" class="l-table-edit-td" id="tdColor">
                <input type="text" id="txtTitleColor" ltype="text" maxlength="10" value="@Model.TitleColor" />
            </td>
        </tr>
        <tr>
            <td align="right" class="l-table-edit-td-left">
                外链：
            </td>
            <td align="left" class="l-table-edit-td">
                <input type="text" id="txtLinkurl" ltype="text" maxlength="50" value="@Model.Linkurl" />
            </td>
            <td align="right" class="l-table-edit-td-left">
                标题图片：
            </td>
            <td align="left" class="l-table-edit-td">               
                <div style="float:left"><input type="file" name="uploadify" id="uploadify" /></div>
                <div id="divFile" style="display:none"><a href="javascript:void(0)" id="aFile">标题图片</a></div>
            </td>
        </tr> 
        <tr>
            <td align="right" class="l-table-edit-td-left">
                来源：
            </td>
            <td align="left" class="l-table-edit-td">
                <input type="text" id="txtSource" ltype="text" maxlength="50" value="@Model.Source" />
            </td>
            <td align="right" class="l-table-edit-td-left">
                作者：
            </td>
            <td align="left" class="l-table-edit-td">
                <input type="text" id="txtAuthor"" ltype="text" maxlength="50" value="@Model.Author" />
            </td>
        </tr> 
        <tr>
            <td align="right" class="l-table-edit-td-left">
                简介：
            </td>
            <td align="left" class="l-table-edit-td" colspan="3">
                <textarea rows="4" class="l-textarea" id="txtAbstruct" style="width: 600px">@Model.Abstruct</textarea>
            </td>
        </tr>
        <tr>
            <td align="right" class="l-table-edit-td-left">
                <span style="color: Red">*</span>内容：
            </td>
            <td align="left" class="l-table-edit-td" colspan="3">
                <script id="txtContent" type="text/plain" style="height: 100px; width:600px;">@Html.Raw(Model.Content)</script>
            </td>
        </tr>
        <tr>
            <td align="right" class="l-table-edit-td-left">
                附件上传：
            </td>
            <td align="left" class="l-table-edit-td">               
                <div style="float:left"><input type="file" name="uploadfj" id="uploadfj" /></div>
                <div id="divFilefj" style="display:none"><a href="javascript:void(0)" id="aFilefj">附件</a></div>
            </td>

            <td align="right" class="l-table-edit-td-left">
                排序：
            </td>
            <td align="left" class="l-table-edit-td">
                <input type="text" id="txtOrder"" ltype="text" maxlength="50" value="@Model.SortID" onkeyup="value=value.replace(/[^\d]/g,'') " onbeforepaste="clipboardData.setData('text',clipboardData.getData('text').replace(/[^\d]/g,''))" />
            </td>

        </tr>
    </table>
    </form>
</div>
@section Scripts{
    <script type="text/javascript" src="@Html.RootPath()/Scripts/Uploadify/jquery.uploadify.js"></script>
    <script src="@Html.RootPath()/Scripts/validation/jquery.validate.min.js" type="text/javascript"></script>
    <script src="@Html.RootPath()/Scripts/validation/jquery.metadata.js?111" type="text/javascript"></script>
    <script src="@Html.RootPath()/Scripts/validation/messages_cn.js" type="text/javascript"></script>
    <script type="text/javascript" src="@Html.RootPath()/Content/MiniColors/jquery.miniColors.min.js"></script>

    <script src="@Html.RootPath()/Scripts/jquery.json.min.js" type="text/javascript"></script>
    <script type="text/javascript" charset="utf-8" src="@Html.RootPath()/content/ueditor/ueditor.config2.js"></script>
    <script type="text/javascript" charset="utf-8" src="@Html.RootPath()/content/ueditor/ueditor.all.min.js"> </script>
    <!--建议手动加在语言，避免在ie下有时因为加载语言失败导致编辑器加载失败-->
    <!--这里加载的语言文件会覆盖你在配置项目里添加的语言类型，比如你在配置项目里配置的是英文，这里加载的中文，那最后就是中文-->
    <script type="text/javascript" charset="utf-8" src="@Html.RootPath()/content/ueditor/lang/zh-cn/zh-cn.js"></script>

    <script language="javascript" type="text/javascript">
        UE.getEditor('txtContent');
        var imgSrc = '@Model.TitlePhoto', fjSrc = '@Model.FJPath';
        $(function () {
            
            if ('@Model.IsBold' == "True")
                $("#chkIsBold").attr("checked", "checked");
            if ('@Model.IsItalic' == "True")
                $("#chkIsItalic").attr("checked", "checked");
            InitColor();
            $("#txtTitleColor").val('');
            $("#uploadify").uploadify({
                postData: { folder: 'SiteContent/TitlePhoto' },
                uploader: '@Html.RootPath()/Upload/Save/',
                buttonText: '标题图片',
                fileTypeDesc: 'Image Files',
                fileTypeExts: "@Html.UploadImgExt()",
                swf: '@Html.RootPath()/Scripts/Uploadify/uploadify.swf',
                onUploadSuccess: function (obj, data, response) {
                    var result = eval("(" + data + ")");
                    if (result.result == "success") {
                        imgSrc = result.url;
                        LoadImage(imgSrc);
                    }
                    else {
                        alert(result.msg);
                        return;
                    }
                }
            });

            $("#uploadfj").uploadify({
                postData: { folder: 'SiteContent/FJList' },
                uploader: '@Html.RootPath()/Upload/Save/',
                buttonText: '上传附件',
                fileTypeDesc: 'Files',
                fileTypeExts: "@Html.UploadFileExt()",
                swf: '@Html.RootPath()/Scripts/Uploadify/uploadify.swf',
                onUploadSuccess: function (obj, data, response) {
                    var result = eval("(" + data + ")");
                    if (result.result == "success") {
                        fjSrc = result.url;
                        LoadImagefj(fjSrc);
                    }
                    else {
                        alert(result.msg);
                        return;
                    }
                }
            });
            

            $("form").ligerForm({ inputWidth: 240 });
            //var txtContent = UE.getEditor('txtContent').getContent();
            LoadImage(imgSrc);
            LoadImagefj(fjSrc);
            var style = '';
            $("#tdColor div,input").each(function () {
                style = $(this).attr("style");
                if (style == null || style == undefined) return;
                $(this).attr("style", "width:235px;float:left");
            });
        });

        function InitColor() {
            var obj = $("#txtTitleColor");
            obj.miniColors({
                letterCase: 'uppercase',
                change: function (hex, rgb) {

                }
            });
            if ($.trim(obj.val()).length > 0)
                obj.miniColors('value', obj.val());
        }

        function LoadImage(url) {
            if (url.length < 1)
                $("#divFile").css("display", "none");
            else {
                //$("#aFile").attr("href", "@Html.UploadPath()" + url);
                $("#aFile").unbind("click");
                $("#aFile").click(function () { DownLoad('@Html.RootPath()', url, '标题图片'); return false; });
                $("#divFile").css("display", "inline");
            }
        }
        function LoadImagefj(url) {
            if (url.length < 1)
                $("#divFilefj").css("display", "none");
            else {
                //$("#aFile").attr("href", "@Html.UploadPath()" + url);
                $("#aFilefj").unbind("click");
                $("#aFilefj").click(function () { DownLoad('@Html.RootPath()', url, '附件'); return false; });
                $("#divFilefj").css("display", "inline");
            }
        }

        function Save(manager, dialog, ChannelID) {
            var objTitle = $("#txtTitle"), title = $.trim(objTitle.val());
            if (title.length < 1) {
                alert("请输入标题！");
                objTitle.focus();
                return;
            }
            var objNode = $("#txtAbstruct"), node = $.trim(objNode.val());
            if (node.length > 250) {
                alert("简介必须小于250个字符！");
                objNode.focus();
                return;
            }
            if (UE.getEditor("txtContent").getContent().length < 1) {
                alert("请输入内容！");
                $("#txtContent").focus();
                return;
            }
            var saveParams = {
                ContentID: '@Model.ContentID',
                ChannelID: ChannelID,
                Title: title,
                Linkurl: $.trim($("#txtLinkurl").val()),
                TitleColor: $.trim($("#txtTitleColor").val()),
                IsBold: document.getElementById("chkIsBold").checked,
                IsItalic: document.getElementById("chkIsItalic").checked,
                Source: $.trim($("#txtSource").val()),
                Author: $.trim($("#txtAuthor").val()),
                Tags: $.trim($("#txtTags").val()),
                TitlePhoto: imgSrc,
                FJPath: fjSrc,
                SortID: $.trim($("#txtOrder").val()),
                Abstruct: node,
                Content: UE.getEditor("txtContent").getContent()
            };
            $.ajax({
                type: 'POST',
                url: '@Html.RootPath()/SiteContent/Save/',
                data: saveParams,
                cache: false,
                success: function (data) {
                    alert(data.msg);
                    if (data.result == "success") {
                        dialog.close();
                        manager.loadData();
                    }
                },
                error: function (xhr) {
                    alert('数据源访问错误' + '\n' + xhr.responseText);
                }
            });
        }
    </script>
}
