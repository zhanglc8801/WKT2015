@model WKT.Model.ContributionInfoEntity
<link href="@Html.RootPath()/Content/ContributionInfo.css" rel="stylesheet" type="text/css" />
<div style="width: 99%; padding: 2px;">
    <div style="margin: 5px; padding: 5px;">
        <div id="divTopmenu" style="margin-bottom: 10px;">
        </div>
        <h2 style="margin-bottom: 5px;">
            《@Model.Title》(稿件编号：@Model.CNumber)</h2>
        <p style="margin-top: 10px;">
            发送人：<span id="spanSendUser"></span> <<span id="spanSendMail"></span>></p>
        <p style="margin-top: 10px;">
            发送时间：<span id="spanSendDate"></span> (星期<span id="spanWeek"></span>)</p>
        <p style="margin-top: 10px;">
            接收人：<span id="spanRecUser"></span> <<span id="spanRecMail"></span>></p>
        <p style="margin-top: 10px;display:block;" id="pAtt">
            我的稿件：<span id="oldFile1"></span>&nbsp;<span id="oldFile2"></span>&nbsp;<span id="oldFile3"></span>&nbsp;<span id="oldFile4"></span>&nbsp;&nbsp;由编辑部发送：<span id="newFile1"></span>&nbsp;<span id="newFile2"></span><br />
        </p>
        <p style="margin-top: 10px; cursor: pointer; color: Blue" id="aRemark">
            点击此处添加备注
        </p>
        <div style="margin-top: 10px; display: none; vertical-align: top" id="divRemark">
            <table cellpadding="2">
                <tr>
                    <td valign="top">
                        备注：
                    </td>
                    <td>
                        <textarea rows="2" cols="20" id="txtCRemark" class="txtbox" style="height: 60px;
                            width: 300px;">@Model.CRemarkInfo.Remark</textarea>
                    </td>
                </tr>
                <tr style="margin-top: 2px;">
                    <td>
                    </td>
                    <td>
                        <input type="button" id="btnSave" value="保存" class="btnadd" />
                        <input type="button" id="btnCancel" value="取消" class="btndelete" />
                    </td>
                </tr>
            </table>
        </div>
    </div>
    <div class="dragLayer">
        <div class="dragHeader" style="cursor: pointer;" onclick="OpenTags('aFlowLog','divFlowLog')">
            <div style="float: left;">
                流程记录(<span id="spanFlow">0</span>条)
            </div>
            <div style="float: right; width: 70%; text-align: right; cursor: pointer;" id="aFlowLog">
                >> 展开
            </div>
        </div>
        <div id="divFlowLog" style="display: none; padding: 10px; color: Green;">
            <img src="@Html.RootPath()/Content/images/checkreg.gif" style="vertical-align:middle;" /><span style="font-size:14px;color:#333;">正在加载...</span>
        </div>
    </div>
    <div class="dragLayer">
        <div class="dragHeader" style="cursor: pointer;" onclick="OpenTags('aContribution','divContribution')">
            <div style="float: left">
                稿件信息
            </div>
            <div style="float: right; width: 70%; text-align: right" id="aContribution">
                >> 展开
            </div>
        </div>
        <div id="divContribution" style="display: none">
            <table border="0" class="mainTable" cellpadding="0" cellspacing="1" align="center"
                width="100%">
                <tr>
                    <td class="left" style="width: 80px;">
                        中文标题：
                    </td>
                    <td class="right">
                        @Model.Title
                    </td>
                </tr>
                @{
                    var field = Model.FieldList.Find(p => p.DBField.Equals("EnTitle"));
                    if (field != null && field.IsShow)
                    {        
                    <tr>
                        <td class="left" style="width: 80px;">
                            @field.DisplayName：
                        </td>
                        <td class="right">
                            @Model.EnTitle
                        </td>
                    </tr>
                    }
                }
                <tr>
                    <td class="left" style="width: 80px;">
                        学科分类：
                    </td>
                    <td class="right">
                        @Html.Raw(@Html.SelectDcitValue("SubjectCat", "200px;\" disabled=\"disabled", "SubjectCat", Model.SubjectCat.ToString(), string.Empty, string.Empty))
                    </td>
                </tr>
                <tr>
                    <td class="left" style="width: 80px;">
                        拟投栏目：
                    </td>
                    <td class="right">
                        @Html.Raw(@Html.SelectJChannel("JChannelID", "200px;\" disabled=\"disabled", Model.JChannelID.ToString(), string.Empty, string.Empty))
                    </td>
                </tr>
                <tr>
                    <td class="left" style="width: 80px;">
                        投稿类型：
                    </td>
                    <td class="right">
                        @Html.Raw(@Html.SelectDcitValue("ContributionType", "200px;\" disabled=\"disabled", "ContributionType", Model.ContributionType.ToString(), string.Empty, string.Empty))
                    </td>
                </tr>
                <tr id="SelSpecial" style="display:none;">
                    <td class="left" style="width: 80px;">
                        约稿人：
                    </td>
                    <td class="right">
                        @Html.Raw(@Html.SelectDcitValue("Special", "200px;\" disabled=\"disabled", "Special", Model.Special.ToString(), "0", "未选择约稿人"))
                    </td>
                </tr>
                <tr>
                    <td class="left" style="width: 80px;">
                        中文关键词：
                    </td>
                    <td class="right">
                        @Model.Keywords
                    </td>
                </tr>
                @{
                    field = Model.FieldList.Find(p => p.DBField.Equals("EnKey"));
                    if (field != null && field.IsShow)
                    {      
                    <tr>
                        <td class="left" style="width: 80px;">
                            @field.DisplayName：
                        </td>
                        <td class="right">
                            @Model.EnKeywords
                        </td>
                    </tr>
                    }
                    field = Model.FieldList.Find(p => p.DBField.Equals("Abstract"));
                    if (field != null && field.IsShow)
                    {
                    <tr>
                        <td class="left" style="width: 80px;">
                            @field.DisplayName：
                        </td>
                        <td class="right">
                            @Model.AttModel.Abstract
                        </td>
                    </tr>
                    }
                    field = Model.FieldList.Find(p => p.DBField.Equals("EnAbstract"));
                    if (field != null && field.IsShow)
                    {
                    <tr>
                        <td class="left" style="width: 80px;">
                            @field.DisplayName：
                        </td>
                        <td class="right">
                            @Model.AttModel.EnAbstract
                        </td>
                    </tr>
                    }
                    field = Model.FieldList.Find(p => p.DBField.Equals("Reference"));
                    if (field != null && field.IsShow)
                    {
                    <tr>
                        <td class="left" style="width: 80px;">
                            @field.DisplayName：
                        </td>
                        <td class="right">
                            <table border="0" class="mainTable" cellpadding="0" cellspacing="1" style="width: 98%">
                                <tr>
                                    <td style="width: 40px;" class="listTitle">
                                        序号
                                    </td>
                                    <td class="listTitle">
                                        文献格式
                                    </td>
                                    <td class="listTitle">
                                        文献来源
                                    </td>
                                </tr>
                                @{
                        int j = 1;
                        foreach (var item in Model.ReferenceList)
                        {
                                    <tr>
                                        <td style="width: 40px;" class="left">
                                            @j
                                        </td>
                                        <td class="left">
                                            @item.Title
                                        </td>
                                        <td class="left">
                                            @item.RefUrl
                                        </td>
                                    </tr>                       
                        }
                                }
                            </table>
                        </td>
                    </tr>
                    }
                    field = Model.FieldList.Find(p => p.DBField.Equals("Fund"));
                    if (field != null && field.IsShow)
                    {
                    <tr>
                        <td class="left" style="width: 80px;">
                            @field.DisplayName：
                        </td>
                        <td class="right">
                            @if (Model.IsFund)
                            {
                                <table border="0" class="mainTable" cellpadding="0" cellspacing="1" style="width: 98%">
                                    <tr>
                                        <td style="width: 40px;" class="listTitle">
                                            序号
                                        </td>
                                        <td style="width: 120px;" class="listTitle">
                                            基金级别
                                        </td>
                                        <td class="listTitle">
                                            基金号
                                        </td>
                                        <td class="listTitle">
                                            基金名称
                                        </td>
                                        <td class="listTitle">
                                            备注
                                        </td>
                                    </tr>
                                    @{
                                int k = 1;
                                foreach (var item in Model.FundList)
                                {
                                        <tr>
                                            <td class="left">@k
                                            </td>
                                            <td class="left">
                                                @Html.Raw(Html.SelectDcitValue("FundLevel_" + k, "100px;\" disabled=\"disabled\"", "FundLevel", item.FundLevel.ToString(), string.Empty, string.Empty))
                                            </td>
                                            <td class="left">
                                                @item.FundCode
                                            </td>
                                            <td class="left">
                                                @item.FundName
                                            </td>
                                            <td class="left">
                                                @item.Note
                                            </td>
                                        </tr>                            
                                    k++;
                                }
                                    }
                                </table>
                            }
                        </td>
                    </tr>
                    }
                    field = Model.FieldList.Find(p => p.DBField.Equals("InvoiceTitle"));
                    if (field != null && field.IsShow)
                    {
                    <tr>
                        <td class="left" style="width: 80px;">
                            @field.DisplayName：
                        </td>
                        <td class="right">
                            @Model.InvoiceTitle
                        </td>
                    </tr>
                    }
                    field = Model.FieldList.Find(p => p.DBField.Equals("CLC"));
                    if (field != null && field.IsShow)
                    {
                    <tr>
                        <td class="left" style="width: 80px;">
                            @field.DisplayName：
                        </td>
                        <td class="right">
                            @Model.CLC
                        </td>
                    </tr>
                    }
                    field = Model.FieldList.Find(p => p.DBField.Equals("CommendExpert"));
                    if (field != null && field.IsShow)
                    {
                    <tr>
                        <td class="left" style="width: 80px;">
                            @field.DisplayName：
                        </td>
                        <td class="right">
                            @Model.CommendExpert
                        </td>
                    </tr>
                    }
                    field = Model.FieldList.Find(p => p.DBField.Equals("ReserveField"));
                    if (field != null && field.IsShow)
                    {
                    <tr>
                        <td class="left" style="width: 80px;">
                            @field.DisplayName：
                        </td>
                        <td class="right">
                            @Model.ReserveField
                        </td>
                    </tr>
                    }
                    field = Model.FieldList.Find(p => p.DBField.Equals("ReserveField1"));
                    if (field != null && field.IsShow)
                    {
                    <tr>
                        <td class="left" style="width: 80px;">
                            @field.DisplayName：
                        </td>
                        <td class="right">
                        @Model.ReserveField1
                    </tr>
                    }
                    field = Model.FieldList.Find(p => p.DBField.Equals("ReserveField2"));
                    if (field != null && field.IsShow)
                    {
                    <tr>
                        <td class="left" style="width: 80px;">
                            @field.DisplayName：
                        </td>
                        <td class="right">
                            @Model.ReserveField2
                        </td>
                    </tr>
                    }
                    field = Model.FieldList.Find(p => p.DBField.Equals("ReserveField3"));
                    if (field != null && field.IsShow)
                    {
                    <tr>
                        <td class="left" style="width: 80px;">
                            @field.DisplayName：
                        </td>
                        <td class="right">
                            @Model.ReserveField3
                        </td>
                    </tr>
                    }
                    field = Model.FieldList.Find(p => p.DBField.Equals("ReserveField4"));
                    if (field != null && field.IsShow)
                    {
                    <tr>
                        <td class="left" style="width: 80px;">
                            @field.DisplayName：
                        </td>
                        <td class="right">
                            @Model.ReserveField4
                        </td>
                    </tr>
                    }
                    field = Model.FieldList.Find(p => p.DBField.Equals("ReserveField5"));
                    if (field != null && field.IsShow)
                    {
                    <tr>
                        <td class="left" style="width: 80px;">
                            @field.DisplayName：
                        </td>
                        <td class="right">
                            @Model.ReserveField5
                        </td>
                    </tr>
                    }
                    field = Model.FieldList.Find(p => p.DBField.Equals("Remark"));
                    if (field != null && field.IsShow)
                    {
                    <tr>
                        <td class="left" style="width: 80px;">
                            @field.DisplayName：
                        </td>
                        <td class="right">
                            @Model.AttModel.Remark
                        </td>
                    </tr>
                    }                   
                }
            </table>
        </div>
    </div>
    <div class="dragLayer">
        <div class="dragHeader" style="cursor: pointer;" onclick="OpenTags('aAuthor','divAuthor')">
            <div style="float: left">
                作者信息(@Model.AuthorList.Count)
            </div>
            <div style="float: right; width: 70%; text-align: right" id="aAuthor">
                >> 展开
            </div>
        </div>
        <div id="divAuthor" style="display: none">
            @{
                int i = 1;
                foreach (var item in Model.AuthorList)
                {
                <table border="0" class="mainTable" cellpadding="0" cellspacing="1" align="center"
                    width="98%" style="margin-bottom: 1px;">
                    <tr>
                        <td class="left" style="width: 80px;">
                            通信作者：
                        </td>
                        <td class="right" colspan="3">
                            @Html.Raw(item.IsCommunication ? "√ " : string.Empty)
                        </td>
                    </tr>
                    <tr>
                        <td class="left" style="width: 80px;">
                            姓名：
                        </td>
                        <td class="right" style="width: 38%;">
                            @Html.Raw(item.AuthorName + "(第" + i + "作者)")
                        </td>
                        <td class="left" style="width: 80px;">
                            性别：
                        </td>
                        <td class="right">
                            @Html.Raw(item.Gender)
                        </td>
                    </tr>
                    <tr>
                        <td class="left">
                            出生年月：
                        </td>
                        <td class="right">
                            @Html.Raw(item.Birthday == null ? "" : item.Birthday.Value.ToString("yyyy年MM月dd日"))
                        </td>
                        <td class="left" style="width: 80px;">
                            民族：
                        </td>
                        <td class="right">
                            @item.Nation
                        </td>
                    </tr>
                    <tr>
                        <td class="left">
                            籍贯：
                        </td>
                        <td class="right">
                            @item.NativePlace
                        </td>
                        <td class="left" style="width: 80px;">
                            单位：
                        </td>
                        <td class="right">
                            @item.WorkUnit
                        </td>
                    </tr>
                    <tr>
                        <td class="left">
                            手机：
                        </td>
                        <td class="right">
                            @item.Mobile
                        </td>
                        <td class="left" style="width: 80px;">
                            电子邮箱：
                        </td>
                        <td class="right">
                            @item.Email
                        </td>
                    </tr>
                    <tr>
                        <td class="left">
                            科室：
                        </td>
                        <td class="right">
                            @item.SectionOffice
                        </td>
                        <td class="left" style="width: 80px;">
                            邮编：
                        </td>
                        <td class="right">
                            @item.ZipCode
                        </td>
                    </tr>
                    <tr>
                        <td class="left">
                            联系电话：
                        </td>
                        <td class="right">
                            @item.Tel
                        </td>
                        <td class="left">
                            联系地址：
                        </td>
                        <td class="right">
                            @item.Address
                        </td>
                    </tr>
                </table>
                    i++;
                }
            }
        </div>
    </div>
</div>
@section Scripts{
    <script type="text/javascript">
        var CID = '@Model.CID', CNumber = '@Model.CNumber';
        $(function () {
            if ($("#ContributionType").val() == 2)//如果投稿类型是特约稿 显示约稿人信息
                $("#SelSpecial").removeAttr("style");
            $("#aRemark").click(function () {
                $(this).slideToggle('medium');
                $("#divRemark").slideToggle('medium');
            });
            $("#btnCancel").click(function () {
                $("#divRemark").slideToggle('medium');
                $("#aRemark").slideToggle('medium');
            });
            $("#btnSave").click(function () {
                var remark = $.trim($("#txtCRemark").val());
                if (remark.length > 200) {
                    alert("最多输入200个字符！");
                    return false;
                }
                $.ajax({
                    type: 'POST',
                    url: '@Html.RootPath()/ContributionInfo/SaveCRemark/',
                    data: {
                        CID: CID,
                        RemarkID: '@Model.CRemarkInfo.RemarkID',
                        Remark: remark
                    },
                    cache: false,
                    success: function (data) {
                        alert(data.msg);
                    },
                    error: function (xhr) {
                        alert('数据源访问错误' + '\n' + xhr.responseText);
                    }
                });
            });
            InitButton('@Model.Status');
            InitFlowLog();
        });

        function OpenTags(tId, cId) {
            if ($("#" + cId).css("display") == "none") {
                $("#" + tId).text("<< 折叠");
            }
            else {
                $("#" + tId).text(">> 展开");
            }
            $("#" + cId).slideToggle('medium');
        }
        
        function InitFlowLog() {
            var isViewMoreFlow=0;
            if('@Html.isViewMoreFlow()'=="True"){
                isViewMoreFlow=1;
            }
            $.ajax({
                type: 'POST',
                url: '@Html.RootPath()/ContributionInfo/GetFlowLogList/',
                data: {
                    CID: CID, isViewMoreFlow: isViewMoreFlow
                },
                cache: false,
                success: function (data) {
                    var list = data, str = '', x = 0;
                    for (var i = 0; i < list.length; i++) {
                        str += '<div class="liucheng">' + GetDate(list[i].AddDate, "yyyy-MM-dd HH:mm:ss");
                        str += '（' + list[i].SendUserGroupName + '）' + list[i].SendUserName + '&nbsp;<img src="@Html.RootPath()/content/img/jiantou.gif" width="11" height="8" />&nbsp;';
                        str += list[i].StatusName + '&nbsp;<img src="@Html.RootPath()/content/img/jiantou.gif" width="11" height="8" />&nbsp;';
                        str += '（' + list[i].RecUserGroupName + '）' + list[i].RecUserName;
                        if (list[i].CPath != "" && list[i].CPath != null && (list[i].SendRoleID == 2 || list[i].RecRoleID == 2)) {
                            if (list.length == 1 && i == 0) {
                                str += "&nbsp;<a href=\"@Html.RootPath()/Upload/Download?cid=" + list[i].CID + "&FlowLogID=" + list[i].FlowLogID + "&fileName=@Model.CNumber《@Model.Title》&downType1=1&downType2=3&isDown=true \">[原始稿]</a>&nbsp;<a href=\"@Html.RootPath()/Plugins/WordOnline.aspx?FlowID=" + list[i].FlowLogID + "&FileName=《@Model.Title》(稿件编号：@Model.CNumber)" + "\" target=\"_blank\">[在线打开]</a>";
                            }
                            if (list.length > 1) {
                                if (i == list.length - 1) {
                                    str += "&nbsp;<a href=\"@Html.RootPath()/Upload/Download?cid=" + list[i].CID + "&FlowLogID=" + list[i].FlowLogID + "&fileName=@Model.CNumber《@Model.Title》&downType1=1&downType2=3&isDown=true \">[原始稿]</a>&nbsp;<a href=\"@Html.RootPath()/Plugins/WordOnline.aspx?FlowID=" + list[i].FlowLogID + "&FileName=《@Model.Title》(稿件编号：@Model.CNumber)" + "\" target=\"_blank\">[在线打开]</a>";
                                } else {
                                    if (list[i].CFileName == "")
                                        str += "&nbsp;<a href=\"@Html.RootPath()/Upload/Download?cid=" + list[i].CID + "&FlowLogID=" + list[i].FlowLogID + "&fileName=@Model.CNumber《@Model.Title》_修改稿&downType1=1&downType2=3&isDown=true \">[修改稿]</a>&nbsp;<a href=\"@Html.RootPath()/Plugins/WordOnline.aspx?FlowID=" + list[i].FlowLogID + "&FileName=《@Model.Title》(稿件编号：@Model.CNumber)" + "\" target=\"_blank\">[在线打开]</a>";
                                    else
                                        str += "&nbsp;<a href=\"@Html.RootPath()/Upload/Download?cid=" + list[i].CID + "&FlowLogID=" + list[i].FlowLogID + "&fileName=@Model.CNumber《@Model.Title》_" + list[i].CFileName + "&downType1=1&downType2=3&isDown=true \">[" + list[i].CFileName + "]</a>&nbsp;<a href=\"@Html.RootPath()/Plugins/WordOnline.aspx?FlowID=" + list[i].FlowLogID + "&FileName=《@Model.Title》(稿件编号：@Model.CNumber)" + "\" target=\"_blank\">[在线打开]</a>";

                                }
                            }

                        }
                        if (list[i].FigurePath != "" && list[i].FigurePath != null && (list[i].SendRoleID == 2 || list[i].RecRoleID == 2)) {
                            if (list[i].FFileName == "")
                                str += "&nbsp;<a href=\"@Html.RootPath()/Upload/Download?cid=" + list[i].CID + "&FlowLogID=" + list[i].FlowLogID + "&fileName=@Model.CNumber《@Model.Title》_附件&downType1=2&downType2=3&isDown=true \">[附件]</a>";
                            else
                                str += "&nbsp;<a href=\"@Html.RootPath()/Upload/Download?cid=" + list[i].CID + "&FlowLogID=" + list[i].FlowLogID + "&fileName=@Model.CNumber《@Model.Title》_" + list[i].FFileName + "&downType1=2&downType2=3&isDown=true \">[" + list[i].FFileName + "]</a>";

                        }
                        if (list[i].OtherPath != "" && list[i].OtherPath != null) {
                            str += "&nbsp;<a href=\"@Html.RootPath()/Upload/Download?cid=" + list[i].CID + "&FlowLogID=" + list[i].FlowLogID + "&fileName=@Model.CNumber《图表介绍信》&downType1=3&downType2=3&isDown=true \">[图表/介绍信]</a>";
                        }
                        if (list[i].DealAdvice != "" && (list[i].SendRoleID == 2 || list[i].RecRoleID == 2)) {
                            var index = list[i].FormatDealAdvice.indexOf('A1');
                            var lastIndex = list[i].FormatDealAdvice.lastIndexOf('A2');
                            var content = list[i].FormatDealAdvice.substring(index + 2, lastIndex);
                            list[i].FormatDealAdvice = list[i].FormatDealAdvice.replace('A1', '<a href=' + content + ' target="_blank">').replace('A2', '</a>');
                            str += "<div style=\"margin-top:5px;margin-left:20px;color:#000000;\">" + list[i].FormatDealAdvice + "</div>";
                        }
                        // 设置顶部显示
                        $("#spanSendUser").text(list[0].SendUserName);
                        $("#spanSendMail").text(list[0].SendUserEmail);
                        $("#spanRecUser").text(list[0].RecUserName);
                        $("#spanRecMail").text(list[0].RecUserEmail);
                        $("#spanSendDate").text(GetDate(list[0].AddDate, "yyyy-MM-dd HH:mm:ss"));
                        $("#spanWeek").text(GetWeek(list[0].AddDate));
                        if (list.length == 1) {
                            if (list[0].CPath != "" && list[0].CPath != null) {
                                $("#oldFile2").html("<a href=\"@Html.RootPath()/Upload/Download?cid=" + list[0].CID + "&FlowLogID=" + list[i].FlowLogID + "&fileName=" + list[0].CNumber + "《@Model.Title》&downType1=1&downType2=1&isDown=true \">[原始稿]</a>");
                            }
                            if (list[0].FigurePath != "" && list[0].FigurePath != null) {
                                $("#oldFile3").html("<a href=\"@Html.RootPath()/Upload/Download?cid=" + list[0].CID + "&FlowLogID=" + list[i].FlowLogID + "&fileName=@Model.CNumber《@Model.Title》_附件&downType1=2&downType2=2&isDown=true \">[附件]</a>&nbsp;");
                            }
                            if (list[0].OtherPath != "" && list[0].OtherPath != null) {
                                $("#oldFile4").html("<a href=\"@Html.RootPath()/Upload/Download?cid=" + list[0].CID + "&FlowLogID=" + list[i].FlowLogID + "&fileName=@Model.CNumber《@Model.Title》_图表介绍信&downType1=3&downType2=2&isDown=true \">[图表/介绍信]</a>");
                            }
                            $("#newFile1").html("《无》");
                        }
                        else {
                            //如果最新状态是作者转编辑
                            if (list[0].SendUserID == '@Model.AuthorID') {
                                if (list[0].CPath != "" && list[0].CPath != null)
                                    $("#oldFile1").html("<a href=\"@Html.RootPath()/Upload/Download?cid=" + list[0].CID + "&FlowLogID=" + list[0].FlowLogID + "&fileName=" + list[0].CNumber + "《@Model.Title》&downType1=1&downType2=3&isDown=true \">[最新修改稿]</a>");
                                $("#newFile1").html("《无》");

                            }
                            else {//如果最新状态是编辑转作者或编辑转编辑 
                                if (list[0].RecRoleID == 2) {
                                    if (list[0].CPath.length>0) {
                                        if (list[0].CFileName == "")
                                            $("#newFile1").html("<a href=\"@Html.RootPath()/Upload/Download?cid=" + list[0].CID + "&FlowLogID=" + list[0].FlowLogID + "&fileName=@Model.CNumber《@Model.Title》&downType1=1&downType2=3&isDown=true \">[修改稿]</a>");
                                        else
                                            $("#newFile1").html("<a href=\"@Html.RootPath()/Upload/Download?cid=" + list[0].CID + "&FlowLogID=" + list[0].FlowLogID + "&fileName=@Model.CNumber《@Model.Title》_" + list[0].CFileName + "&downType1=1&downType2=3&isDown=true \">[" + list[0].CFileName + "]</a>");

                                    }
                                    if (list[0].FigurePath.length>0) {
                                        if (list[0].FFileName == "")
                                            $("#newFile2").html("<a href=\"@Html.RootPath()/Upload/Download?cid=" + list[0].CID + "&FlowLogID=" + list[0].FlowLogID + "&fileName=@Model.CNumber《@Model.Title》_附件&downType1=2&downType2=2&isDown=true \">[附件]</a>&nbsp;");
                                        else
                                            $("#newFile2").html("<a href=\"@Html.RootPath()/Upload/Download?cid=" + list[0].CID + "&FlowLogID=" + list[0].FlowLogID + "&fileName=@Model.CNumber《@Model.Title》_" + list[0].FFileName + "&downType1=2&downType2=2&isDown=true \">[" + list[0].FFileName + "]</a>");
                                    }
                                    if (list[0].CPath.length == 0 && list[0].FigurePath.length == 0) {
                                        $("#newFile1").html("《无》");
                                    }
                                }
                                else {
                                    $("#newFile1").html("《无》");
                                }
                                if (list[i].SendRoleID == 2 && x == 0) {
                                    if (list[i].CPath != "" && list[i].CPath != null && i != list.length - 1) {
                                        $("#oldFile1").html("<a href=\"@Html.RootPath()/Upload/Download?cid=" + list[i].CID + "&FlowLogID=" + list[i].FlowLogID + "&fileName=" + list[i].CNumber + "《@Model.Title》&downType1=1&downType2=3&isDown=true \">[最新修改稿]</a>");
                                    }
                                    x++;
                                }                               

                            }

                        }
                    }
                    //个人原始稿件/附件/介绍信
                    if (list[list.length - 1].CPath != "" && list[list.length - 1].CPath != null)
                        $("#oldFile2").html("<a href=\"@Html.RootPath()/Upload/Download?cid=" + list[list.length - 1].CID + "&FlowLogID=" + list[list.length - 1].FlowLogID + "&fileName=" + list[list.length - 1].CNumber + "《@Model.Title》&downType1=1&downType2=1&isDown=true \">[原始稿]</a>");
                    if (list[list.length - 1].FigurePath != "" && list[list.length - 1].FigurePath != null)
                        $("#oldFile3").html("<a href=\"@Html.RootPath()/Upload/Download?cid=" + list[list.length - 1].CID + "&FlowLogID=" + list[list.length - 1].FlowLogID + "&fileName=@Model.CNumber《@Model.Title》_附件&downType1=2&downType2=1&isDown=true \">[附件]</a>");
                    if (list[list.length - 1].OtherPath != "" && list[list.length - 1].OtherPath != null)
                        $("#oldFile4").html("<a href=\"@Html.RootPath()/Upload/Download?cid=" + list[0].CID + "&FlowLogID=" + list[list.length - 1].FlowLogID + "&fileName=@Model.CNumber《@Model.Title》_图表介绍信&downType1=3&downType2=1&isDown=true \">[图表/介绍信]</a>");
                    $("#spanFlow").html(list.length);
                    $("#divFlowLog").html(str);
                },
                error: function (xhr) {
                    alert('数据源访问错误' + '\n' + xhr.responseText);
                }
            });
        }

        function InitButton(status) {
            var itemList = null;
            switch (status) {
                case '0': itemList = [
                    // { text: '发送消息', click: SendSms, icon: 'add' },
                                      {text: '撤    稿', click: Cancel, icon: 'delete'}];
                    break; //新投稿
                case '-1': itemList = [{ text: '草稿投稿', click: Update, icon: 'modify', name: 'DraftIndexUpdate'}]; break; //草稿
//                case '-3': itemList = [{ text: '修改上传', click: Update, icon: 'modify', name: 'RetreatIndexUpdate' },
//                                      { text: '发送消息', click: SendSms, icon: 'add'}];
//                    break; //退修
                case '100': itemList = [{ text: '修改上传', click: Update, icon: 'modify', name: 'ProofIndexUpdate' },
                                      { text: '发送消息', click: SendSms, icon: 'add'}];
                    break; //已发校样
                case '200': itemList = [{ text: '发送消息', click: SendSms, icon: 'add'}]; break; //录用稿件
                case '-100': itemList = [{ text: '修改', click: Update, icon: 'modify', name: 'ManuscriptIndexUpdate' },
                                        { text: '转投他刊', click: SwitchTo, icon: 'add'}];
                    break; //退稿
                case '-2': itemList = [{ text: '修改上传', click: Update, icon: 'modify', name: 'FormatIndexUpdate'}]; break; //格式修改
            }
            if (itemList != null)
                $("#divTopmenu").ligerMenuBar({ items: itemList });
        }

        function Update(item) {
            window.parent.RemoveSelectedAndRedirect(item.name, item.text + '[' + CNumber + ']', '@Html.RootPath()/ContributionInfo/Index?CID=' + CID);
        }

        function SendSms() {
            $.ligerDialog.open({
                height: 500,
                width: 800,
                url: '@Html.RootPath()/ContributionInfo/SendSms?Status=@Model.Status',
                title: '发送消息',
                slide: false,
                buttons: [{ text: '发送', onclick: function (item, dialog) {
                    dialog.frame.Save(null, dialog, CID);
                }
                }, { text: '关闭', onclick: function (item, dialog) { dialog.close(); } }]
            });
        }

        function SwitchTo() {
        }

        function Cancel() {
            $.ajax({
                type: 'POST',
                url: '@Html.RootPath()/ContributionInfo/GetDraftModel/',
                data: { CID: CID },
                cache: false,
                success: function (data) {
                    if (data.result == "success") {
                        Draft(data.model.Reason, data.model.PKID);
                    }
                    else {
                        Draft('', 0);
                    }
                },
                error: function (xhr) {
                    alert('数据源访问错误' + '\n' + xhr.responseText);
                }
            });
        }

        function Draft(Reason, PKID) {
            $.ligerDialog.open({
                height: 240,
                width: 400,
                content: '<textarea id="txtReason" class="l-dialog-textarea" style="width:370px;height:170px;">' + Reason + '</textarea>',
                title: '撤稿[' + CNumber + ']',
                slide: false,
                buttons: [{ text: '确定', onclick: function (item, dialog) {
                    var val = $.trim($("#txtReason").val());
                    if (val.length < 1) {
                        alert("请输入撤稿原因！");
                        return;
                    }
                    if ('@Html.isAutoHandle()' == 'true') {
                        if (!confirm("系统已设置为自动处理撤稿申请，确定后将立即撤稿！您确定要继续撤稿吗？")) return;
                    }
                    else {
                        if (!confirm("您确定申请撤稿吗？申请后需经编辑部同意才能成功撤稿。")) return;
                    }
                    $.ajax({
                        type: 'POST',
                        url: '@Html.RootPath()/ContributionInfo/Draft/',
                        data: {
                            PKID: PKID,
                            CID: CID,
                            Reason: val,
                            isAutoHandle:'@Html.isAutoHandle()'
                        },
                        cache: false,
                        success: function (data) {
                            alert(data.msg);
                            if (data.result == "success") {
                                dialog.close();
                                manager.loadData();
                            }
                        },
                        error: function (xhr) {
                            alert('数据源访问错误' + '\n' + xhr.responseText);
                        }
                    });
                }
                }, { text: '取消', onclick: function (item, dialog) { dialog.close(); } }]
            });
        }

        //当备注不为空时显示备注内容
        if ($("#txtCRemark").val().length > 0) {
            $("#aRemark").slideToggle('medium');
            $("#divRemark").slideToggle('medium');
        }
        //默认显示流程记录
        OpenTags('aFlowLog', 'divFlowLog'); 

    </script>
}
